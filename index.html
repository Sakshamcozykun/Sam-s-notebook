<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sam's Notebook - Resizable/Deletable Elements & Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            background-color: #f0fdf4;
            background-image: radial-gradient(#a7f3d0 1px, transparent 1px), radial-gradient(#a7f3d0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overscroll-behavior: none;
        }

        .notebook-container {
            width: 100%;
            max-width: 80rem;
            height: 85vh;
            max-height: 700px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1500px;
            transition: all 0.3s ease;
        }

        .notebook {
            display: flex;
            width: 100%;
            height: 100%;
            background-color: #a7f3d0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            transform-style: preserve-3d;
            transition: box-shadow 0.3s ease;
        }

        .notebook:hover {
            box-shadow: 0 20px 50px rgba(0,0,0,0.25), 0 7px 15px rgba(0,0,0,0.15);
        }

        .page-display {
            flex: 1;
            height: 100%;
            background-color: white;
            position: relative;
            border: 1px solid #d1d5db;
            overflow: hidden;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.8s ease;
            backface-visibility: hidden;
            transform-origin: left center;
        }

        #left-page {
            border-right: 2px solid #6ee7b7;
            border-radius: 0.5rem 0 0 0.5rem;
            transform-origin: right center;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.03);
        }

        #right-page {
            border-radius: 0 0.5rem 0.5rem 0;
            transform-origin: left center;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.03);
        }

        .page-flipping-out-left { transform: rotateY(-25deg); opacity: 0; }
        .page-flipping-in-left { transform: rotateY(25deg); opacity: 0; }
        .page-flipping-out-right { transform: rotateY(25deg); opacity: 0; }
        .page-flipping-in-right { transform: rotateY(-25deg); opacity: 0; }

        .page-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            background-image: linear-gradient(to bottom, transparent 98%, #9ae6b4 98%);
            background-size: 100% 2em;
            font-family: 'Kalam', cursive;
            padding: 1.5rem;
            overflow: auto;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            scrollbar-width: thin;
            scrollbar-color: #6ee7b7 #f0fdf4;
        }

        .page-content::-webkit-scrollbar {
            width: 8px;
        }

        .page-content::-webkit-scrollbar-track {
            background: #f0fdf4;
        }

        .page-content::-webkit-scrollbar-thumb {
            background-color: #6ee7b7;
            border-radius: 10px;
            border: 2px solid #f0fdf4;
        }

        #page-data-storage { display: none; }

        .scrapbook-element {
            position: absolute;
            cursor: grab;
            border: 1px dashed transparent;
            padding: 5px;
            min-width: 50px;
            min-height: 30px;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
            overflow: visible;
            touch-action: none;
        }

        .scrapbook-element:hover,
        .scrapbook-element.selected {
            border-color: #34d399;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .scrapbook-element.selected {
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3), 0 4px 8px rgba(0,0,0,0.15);
        }

        .scrapbook-element.dragging {
            cursor: grabbing;
            opacity: 0.85;
            z-index: 9999;
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .scrapbook-text {
            font-family: 'Kalam', cursive;
            line-height: 1.5;
            outline: none;
            color: #1f2937;
            min-width: 100px;
            min-height: 1.5em;
            padding: 8px 10px;
            background-color: rgba(254, 252, 232, 0.9);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 4px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .scrapbook-text:focus {
            background-color: rgba(254, 252, 232, 1);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5), 0 2px 4px rgba(0,0,0,0.1);
        }

        .scrapbook-image {
            width: fit-content;
            height: fit-content;
            padding: 0;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .scrapbook-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }

        .scrapbook-image img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .delete-button {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: #ef4444;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            line-height: 21px;
            text-align: center;
            cursor: pointer;
            z-index: 1001;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            opacity: 0;
            transform: scale(0.8);
        }

        .scrapbook-element:hover .delete-button,
        .scrapbook-element.selected .delete-button {
            display: block;
            opacity: 1;
            transform: scale(1);
        }

        .delete-button:hover {
            background-color: #dc2626;
            transform: scale(1.1);
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #34d399;
            border: 2px solid white;
            border-radius: 2px;
            z-index: 1002;
            display: none;
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .scrapbook-image:hover .resize-handle,
        .scrapbook-image.selected .resize-handle {
            display: block;
            opacity: 1;
        }

        .resize-handle:hover {
            transform: scale(1.2);
            background-color: #10b981;
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nwse-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: nesw-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: nwse-resize; }

        .cover-content {
            background-image: linear-gradient(to bottom right, #34d399, #10b981);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: inherit;
            font-family: 'Inter', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
        }

        .cover-content h1 {
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }

        .frog-icon {
            font-size: 4rem;
            margin-top: 1rem;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2));
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .controls-container {
            @apply mt-8 flex justify-center items-center space-x-4 relative;
            padding: 0.75rem;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .controls-container:hover {
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .control-button {
            @apply px-5 py-2 bg-emerald-500 text-white rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75 transition duration-200 ease-in-out flex items-center justify-center;
            font-size: 1rem;
            font-weight: 500;
            min-width: 100px;
            line-height: 1.5;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .control-button:not(:disabled) {
            @apply hover:bg-emerald-600;
        }

        .control-button:not(:disabled):active {
            transform: translateY(1px);
        }

        .control-button:disabled {
            @apply opacity-60 cursor-not-allowed shadow-md bg-emerald-400;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.5s;
        }

        .control-button:not(:disabled):hover::before {
            left: 100%;
        }

        #add-image-button {
            @apply p-3 bg-emerald-500 text-white rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75 transition duration-200 ease-in-out flex items-center justify-center;
            position: relative;
            overflow: hidden;
        }

        #add-image-button:not(:disabled) {
            @apply hover:bg-emerald-600;
        }

        #add-image-button:not(:disabled):active {
            transform: translateY(1px);
        }

        #add-image-button:disabled {
            @apply opacity-60 cursor-not-allowed shadow-md bg-emerald-400;
        }

        #add-image-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.5s;
        }

        #add-image-button:not(:disabled):hover::before {
            left: 100%;
        }

        #add-image-button svg {
            width: 1.5em;
            height: 1.5em;
            flex-shrink: 0;
        }

        .tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            white-space: nowrap;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        .tooltip-trigger:hover .tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .placeholder-page {
            background-color: #f0fdf4;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #a1a1aa;
            font-style: italic;
            user-select: none;
            -webkit-user-select: none;
        }

        .welcome-instructions {
            max-width: 250px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #374151;
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.9) !important;
        }

        .first-note {
            background-color: rgba(254, 240, 138, 0.5) !important;
            border-left: 3px solid #eab308 !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08) !important;
        }

        #image-upload-input {
            display: none;
        }

        @media (max-width: 768px) {
            .notebook-container {
                max-height: 600px;
                height: 70vh;
            }

            .controls-container {
                padding: 0.5rem;
            }

            .control-button {
                min-width: 80px;
                font-size: 0.9rem;
                padding: 0.375rem 1rem;
            }

            #add-image-button {
                padding: 0.375rem;
            }

            #add-image-button svg {
                width: 1.25em;
                height: 1.25em;
            }

            .page-content {
                padding: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-green-50 flex flex-col justify-center items-center min-h-screen p-4 overflow-hidden">

    <div class="notebook-container">
        <div class="notebook">
            <div id="left-page" class="page-display">
                <div class="page-content placeholder-page">(Inside Cover)</div>
            </div>
            <div id="right-page" class="page-display">
                <div class="cover-content" id="cover-content-display">
                    <h1>Sam's Notebook</h1>
                    <div class="frog-icon">🐸</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="image-upload-input" accept="image/*">

    <div class="controls-container">
        <button id="prev-page" class="control-button tooltip-trigger" disabled>
            <span class="tooltip">Previous Page</span>
            < Prev
        </button>
        <button id="add-image-button" class="tooltip-trigger" title="Add Image from Device" disabled>
            <span class="tooltip">Add Image</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
        </button>
        <button id="next-page" class="control-button tooltip-trigger">
            <span class="tooltip">Next Page</span>
            Next >
        </button>
    </div>

    <div id="page-data-storage">
        <div class="page-content" data-page-number="0">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Inside Cover</h2>
            <div class="scrapbook-element scrapbook-text welcome-instructions" style="left: 50px; top: 70px; width: 250px; z-index: 10;" contenteditable="true">
                Welcome to your notebook! Click Next to start writing and adding images to your pages.
            </div>
        </div>

        <div class="page-content" data-page-number="1">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 1</h2>
            <div class="scrapbook-element scrapbook-text welcome-instructions" style="left: 50px; top: 70px; width: 250px; z-index: 10;" contenteditable="true">
                • Double-click to add notes<br>
                • Drag elements to move them<br>
                • Use the image button to add photos<br>
                • Try pasting text or images<br>
                • Click to edit, hover to delete
            </div>
            <div class="scrapbook-element scrapbook-text first-note" style="left: 50px; top: 180px; width: 200px; z-index: 11;" contenteditable="true">My first note! Click to edit or drag me around.</div>
        </div>
        <div class="page-content" data-page-number="2">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 2</h2>
        </div>

        <div class="page-content" data-page-number="3">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 3</h2>
            <div class="scrapbook-element scrapbook-image" style="left: 80px; top: 120px; width: 150px; height: 100px; z-index: 12;">
                <img src="https://placehold.co/150x100/e0e0e0/757575?text=Paste+Image" alt="Placeholder Image">
            </div>
        </div>
        <div class="page-content" data-page-number="4">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 4</h2>
        </div>

        <div class="page-content" data-page-number="5">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 5</h2>
        </div>
        <div class="page-content" data-page-number="6">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Page 6</h2>
        </div>

        <div class="page-content" data-page-number="7">
            <h2 class="text-xl font-semibold mb-4 text-green-800 opacity-60 pointer-events-none absolute top-4 left-4">Inside Back Cover</h2>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const notebook = document.querySelector('.notebook');
            const leftPageDisplay = document.getElementById('left-page');
            const rightPageDisplay = document.getElementById('right-page');
            const pageDataStorage = document.getElementById('page-data-storage');
            const coverContentDisplay = document.getElementById('cover-content-display');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const addImageButton = document.getElementById('add-image-button');
            const imageUploadInput = document.getElementById('image-upload-input');

            const pages = Array.from(pageDataStorage.querySelectorAll('.page-content'))
                .sort((a, b) => parseInt(a.dataset.pageNumber) - parseInt(b.dataset.pageNumber));
            const totalPages = pages.length;
            const totalSpreads = Math.ceil(totalPages / 2) + 1;
            let currentSpreadIndex = 0;
            let elementZIndex = 10;
            let draggedElement = null;
            let offsetX, offsetY;
            let dragStartX, dragStartY;
            let resizingElement = null;
            let resizeHandle = null;
            let startX, startY, startWidth, startHeight;
            let aspectRatio;
            let selectedElement = null;
            const animationDuration = 800;

            function updateView() {
                deselectElement();
                leftPageDisplay.innerHTML = '';
                rightPageDisplay.innerHTML = '';
                coverContentDisplay.style.display = 'none';
                let leftPageContent = null;
                let rightPageContent = null;

                if (currentSpreadIndex === 0) {
                    leftPageContent = createPlaceholderPage("(Inside Cover)");
                    rightPageDisplay.appendChild(coverContentDisplay);
                    coverContentDisplay.style.display = 'flex';
                    addImageButton.disabled = true;
                    addImageButton.title = "Cannot add images to the cover";
                } else {
                    const leftPageNumber = (currentSpreadIndex - 1) * 2;
                    const rightPageNumber = leftPageNumber + 1;
                    leftPageContent = (leftPageNumber >= 0 && leftPageNumber < totalPages) ? pages[leftPageNumber] : createPlaceholderPage("(Blank)");
                    rightPageContent = (rightPageNumber >= 0 && rightPageNumber < totalPages) ? pages[rightPageNumber] : createPlaceholderPage("(End)");
                    const leftIsReal = leftPageContent && !leftPageContent.classList.contains('placeholder-page');
                    const rightIsReal = rightPageContent && !rightPageContent.classList.contains('placeholder-page');
                    addImageButton.disabled = !(leftIsReal || rightIsReal);
                    addImageButton.title = addImageButton.disabled ? "No page available to add image" : "Add Image from Device";
                }

                if (leftPageContent) {
                    leftPageDisplay.appendChild(leftPageContent);
                    attachScrapbookListeners(leftPageContent);
                }
                if (rightPageContent && currentSpreadIndex !== 0) {
                    rightPageDisplay.appendChild(rightPageContent);
                    attachScrapbookListeners(rightPageContent);
                }

                updateButtonStates();
            }

            function createPlaceholderPage(text) {
                const placeholder = document.createElement('div');
                placeholder.classList.add('page-content', 'placeholder-page');
                placeholder.textContent = text;
                return placeholder;
            }

            function selectElement(element) {
                if (selectedElement && selectedElement !== element) {
                    selectedElement.classList.remove('selected');
                    selectedElement.style.zIndex = Math.max(10, parseInt(selectedElement.style.zIndex || 510) - 500);
                }
                if (element) {
                    element.classList.add('selected');
                    selectedElement = element;
                    element.style.zIndex = parseInt(element.style.zIndex || 10) + 500;
                    if (element.classList.contains('scrapbook-text')) {
                        element.focus();
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(element);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            }

            function deselectElement() {
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                    selectedElement.style.zIndex = Math.max(10, parseInt(selectedElement.style.zIndex || 510) - 500);
                    selectedElement = null;
                }
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.scrapbook-element') && (
                    e.target.classList.contains('page-display') ||
                    e.target.classList.contains('page-content') ||
                    e.target.classList.contains('notebook') ||
                    e.target.classList.contains('notebook-container') ||
                    e.target.classList.contains('controls-container') ||
                    e.target === document.body)) {
                    deselectElement();
                }
            });

            function attachScrapbookListeners(pageElement) {
                if (!pageElement || pageElement.classList.contains('placeholder-page')) return;

                let maxZ = elementZIndex;
                pageElement.querySelectorAll('.scrapbook-element').forEach(el => {
                    const currentZ = parseInt(el.style.zIndex);
                    if (!isNaN(currentZ)) maxZ = Math.max(maxZ, currentZ);
                });
                elementZIndex = maxZ + 1;

                pageElement.querySelectorAll('.scrapbook-element').forEach(makeElementInteractive);

                pageElement.addEventListener('dblclick', handlePageDoubleClick);
                pageElement.addEventListener('paste', handlePaste);
            }

            function handlePageDoubleClick(e) {
                const contentArea = e.currentTarget;
                if (e.target !== contentArea || contentArea.classList.contains('placeholder-page') || e.target.closest('.scrapbook-element')) return;

                deselectElement();
                const textElement = document.createElement('div');
                textElement.classList.add('scrapbook-element', 'scrapbook-text');
                textElement.setAttribute('contenteditable', 'true');
                textElement.textContent = 'Type here...';

                const rect = contentArea.getBoundingClientRect();
                const scrollX = contentArea.scrollLeft;
                const scrollY = contentArea.scrollTop;
                const x = e.pageX - rect.left + scrollX - 5;
                const y = e.pageY - rect.top + scrollY - 5;

                textElement.style.position = 'absolute';
                textElement.style.left = `${Math.max(0, x)}px`;
                textElement.style.top = `${Math.max(0, y)}px`;
                elementZIndex++;
                textElement.style.zIndex = elementZIndex;

                contentArea.appendChild(textElement);
                makeElementInteractive(textElement);
                selectElement(textElement);
            }

            function addImageElement(imageDataUrl, targetPageElement) {
                if (!targetPageElement || targetPageElement.classList.contains('placeholder-page')) return;

                deselectElement();
                const imgElementContainer = document.createElement('div');
                imgElementContainer.classList.add('scrapbook-element', 'scrapbook-image');
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                imgElementContainer.appendChild(img);

                const pasteX = targetPageElement.scrollLeft + targetPageElement.offsetWidth * 0.1;
                const pasteY = targetPageElement.scrollTop + targetPageElement.offsetHeight * 0.1;

                imgElementContainer.style.position = 'absolute';
                imgElementContainer.style.left = `${pasteX}px`;
                imgElementContainer.style.top = `${pasteY}px`;
                elementZIndex++;
                imgElementContainer.style.zIndex = elementZIndex;

                img.onload = () => {
                    imgElementContainer.style.width = `${img.offsetWidth}px`;
                    imgElementContainer.style.height = `${img.offsetHeight}px`;
                    makeElementInteractive(imgElementContainer);
                    selectElement(imgElementContainer);
                };
                img.onerror = () => {
                    imgElementContainer.remove();
                    alert("Failed to load the selected image.");
                };

                targetPageElement.appendChild(imgElementContainer);
            }

            function handlePaste(e) {
                const contentArea = e.currentTarget;
                if (contentArea.classList.contains('placeholder-page')) return;

                e.preventDefault();
                const items = (e.clipboardData || window.clipboardData).items;

                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => addImageElement(event.target.result, contentArea);
                        reader.readAsDataURL(blob);
                        break;
                    } else if (item.type === 'text/plain') {
                        item.getAsString(text => {
                            deselectElement();
                            const textElement = document.createElement('div');
                            textElement.classList.add('scrapbook-element', 'scrapbook-text');
                            textElement.setAttribute('contenteditable', 'true');
                            textElement.textContent = text;

                            const rect = contentArea.getBoundingClientRect();
                            const scrollX = contentArea.scrollLeft;
                            const scrollY = contentArea.scrollTop;
                            const pasteX = scrollX + rect.width * 0.1 + 10;
                            const pasteY = scrollY + rect.height * 0.1 + 10;

                            textElement.style.position = 'absolute';
                            textElement.style.left = `${pasteX}px`;
                            textElement.style.top = `${pasteY}px`;
                            elementZIndex++;
                            textElement.style.zIndex = elementZIndex;

                            contentArea.appendChild(textElement);
                            makeElementInteractive(textElement);
                            selectElement(textElement);
                        });
                        break;
                    }
                }
            }

            function addControls(element) {
                if (element.querySelector('.delete-button')) return;

                const deleteBtn = document.createElement('div');
                deleteBtn.classList.add('delete-button');
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete Element';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    element.remove();
                    if (selectedElement === element) selectedElement = null;
                });
                element.appendChild(deleteBtn);

                if (element.classList.contains('scrapbook-image')) {
                    ['nw', 'ne', 'sw', 'se'].forEach(handleType => {
                        const handle = document.createElement('div');
                        handle.classList.add('resize-handle', handleType);
                        handle.addEventListener('mousedown', onResizeHandleMouseDown);
                        element.appendChild(handle);
                    });
                }
            }

            function makeElementInteractive(element) {
                addControls(element);
                element.addEventListener('mousedown', onElementMouseDown);
                const img = element.querySelector('img');
                if (img) img.ondragstart = () => false;
            }

            function onElementMouseDown(e) {
                if (e.button !== 0 || e.target.classList.contains('resize-handle') || e.target.classList.contains('delete-button')) return;

                const element = e.currentTarget;
                selectElement(element);

                draggedElement = element;
                const rect = draggedElement.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                dragStartX = e.clientX;
                dragStartY = e.clientY;

                document.addEventListener('mousemove', onDragMouseMove);
                document.addEventListener('mouseup', onDragMouseUp);
            }

            function onDragMouseMove(e) {
                if (!draggedElement) return;

                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                if (!draggedElement.classList.contains('dragging') && Math.sqrt(dx*dx + dy*dy) > 5) {
                    draggedElement.classList.add('dragging');
                    draggedElement.style.zIndex = 9999;
                }

                if (draggedElement.classList.contains('dragging')) {
                    e.preventDefault();
                    let parent = draggedElement.parentElement;
                    const notebookRect = notebook.getBoundingClientRect();
                    const leftPageRect = leftPageDisplay.getBoundingClientRect();
                    const rightPageRect = rightPageDisplay.getBoundingClientRect();

                    // Determine which page the mouse is over
                    let targetPage = parent;
                    const mouseX = e.clientX;
                    const mouseY = e.clientY;
                    const isOverLeftPage = mouseX >= leftPageRect.left && mouseX <= leftPageRect.right && mouseY >= notebookRect.top && mouseY <= notebookRect.bottom;
                    const isOverRightPage = mouseX >= rightPageRect.left && mouseX <= rightPageRect.right && mouseY >= notebookRect.top && mouseY <= notebookRect.bottom;

                    if (isOverLeftPage && parent === rightPageDisplay.querySelector('.page-content') && !leftPageDisplay.querySelector('.page-content').classList.contains('placeholder-page')) {
                        targetPage = leftPageDisplay.querySelector('.page-content');
                    } else if (isOverRightPage && parent === leftPageDisplay.querySelector('.page-content') && !rightPageDisplay.querySelector('.page-content').classList.contains('placeholder-page')) {
                        targetPage = rightPageDisplay.querySelector('.page-content');
                    }

                    // Move element to target page if it has changed
                    if (targetPage !== parent && targetPage && !targetPage.classList.contains('placeholder-page')) {
                        const oldParentRect = parent.getBoundingClientRect();
                        const newParentRect = targetPage.getBoundingClientRect();

                        // Calculate new position relative to the target page
                        const currentX = parseFloat(draggedElement.style.left) || 0;
                        const currentY = parseFloat(draggedElement.style.top) || 0;
                        let newX = currentX + (oldParentRect.left - newParentRect.left);
                        let newY = currentY + (oldParentRect.top - newParentRect.top);

                        // Append to new page and update position
                        targetPage.appendChild(draggedElement);
                        parent = targetPage;

                        // Ensure position is within new page bounds
                        newX = Math.max(0, Math.min(newX, parent.scrollWidth - draggedElement.offsetWidth));
                        newY = Math.max(0, Math.min(newY, parent.scrollHeight - draggedElement.offsetHeight));
                        draggedElement.style.left = `${newX}px`;
                        draggedElement.style.top = `${newY}px`;
                    }

                    // Update position within the current (or new) parent
                    const parentRect = parent.getBoundingClientRect();
                    let x = e.clientX - parentRect.left - offsetX + parent.scrollLeft;
                    let y = e.clientY - parentRect.top - offsetY + parent.scrollTop;

                    x = Math.max(0, Math.min(x, parent.scrollWidth - draggedElement.offsetWidth));
                    y = Math.max(0, Math.min(y, parent.scrollHeight - draggedElement.offsetHeight));

                    draggedElement.style.left = `${x}px`;
                    draggedElement.style.top = `${y}px`;
                }
            }

            function onDragMouseUp(e) {
                if (!draggedElement) return;

                const wasDragging = draggedElement.classList.contains('dragging');
                draggedElement.classList.remove('dragging');

                if (wasDragging) {
                    elementZIndex++;
                    draggedElement.style.zIndex = elementZIndex;
                }

                draggedElement = null;
                document.removeEventListener('mousemove', onDragMouseMove);
                document.removeEventListener('mouseup', onDragMouseUp);
            }

            function onResizeHandleMouseDown(e) {
                e.stopPropagation();
                e.preventDefault();

                resizingElement = e.target.closest('.scrapbook-image');
                if (!resizingElement) return;

                resizeHandle = e.target;
                const img = resizingElement.querySelector('img');

                startX = e.clientX;
                startY = e.clientY;
                startWidth = resizingElement.offsetWidth;
                startHeight = resizingElement.offsetHeight;
                aspectRatio = img ? img.naturalWidth / img.naturalHeight : startWidth / startHeight;
                if (isNaN(aspectRatio) || aspectRatio <= 0) aspectRatio = 1;

                document.addEventListener('mousemove', onResizeMouseMove);
                document.addEventListener('mouseup', onResizeMouseUp);
            }

            function onResizeMouseMove(e) {
                if (!resizingElement || !resizeHandle) return;
                e.preventDefault();

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const originalLeft = parseFloat(resizingElement.style.left || 0);
                const originalTop = parseFloat(resizingElement.style.top || 0);

                let newWidth = startWidth;
                let newHeight = startHeight;

                if (resizeHandle.classList.contains('se')) {
                    newWidth = startWidth + dx;
                    newHeight = newWidth / aspectRatio;
                } else if (resizeHandle.classList.contains('sw')) {
                    newWidth = startWidth - dx;
                    newHeight = newWidth / aspectRatio;
                } else if (resizeHandle.classList.contains('ne')) {
                    newWidth = startWidth + dx;
                    newHeight = newWidth / aspectRatio;
                } else if (resizeHandle.classList.contains('nw')) {
                    newWidth = startWidth - dx;
                    newHeight = newWidth / aspectRatio;
                }

                const minSize = 30;
                newWidth = Math.max(minSize, newWidth);
                newHeight = newWidth / aspectRatio;
                if (newHeight < minSize) {
                    newHeight = minSize;
                    newWidth = newHeight * aspectRatio;
                }

                resizingElement.style.width = `${newWidth}px`;
                resizingElement.style.height = `${newHeight}px`;

                const widthChange = startWidth - newWidth;
                const heightChange = startHeight - newHeight;

                if (resizeHandle.classList.contains('sw') || resizeHandle.classList.contains('nw')) {
                    resizingElement.style.left = `${originalLeft + widthChange}px`;
                }
                if (resizeHandle.classList.contains('ne') || resizeHandle.classList.contains('nw')) {
                    resizingElement.style.top = `${originalTop + heightChange}px`;
                }
            }

            function onResizeMouseUp(e) {
                if (!resizingElement) return;

                resizingElement = null;
                resizeHandle = null;
                document.removeEventListener('mousemove', onResizeMouseMove);
                document.removeEventListener('mouseup', onResizeMouseUp);
            }

            function nextPage() {
                if (!nextButton.disabled) performPageTurn(1);
            }

            function prevPage() {
                if (!prevButton.disabled) performPageTurn(-1);
            }

            function performPageTurn(direction) {
                deselectElement();
                const outLeftClass = direction > 0 ? 'page-flipping-out-left' : 'page-flipping-in-left';
                const outRightClass = direction > 0 ? 'page-flipping-out-right' : 'page-flipping-in-right';
                const inLeftClass = direction > 0 ? 'page-flipping-in-left' : 'page-flipping-out-left';
                const inRightClass = direction > 0 ? 'page-flipping-in-right' : 'page-flipping-out-right';

                leftPageDisplay.classList.add(outLeftClass);
                rightPageDisplay.classList.add(outRightClass);

                prevButton.disabled = true;
                nextButton.disabled = true;
                addImageButton.disabled = true;

                setTimeout(() => {
                    moveVisibleContentToStorage();
                    currentSpreadIndex += direction;
                    updateView();

                    leftPageDisplay.classList.add(inLeftClass);
                    rightPageDisplay.classList.add(inRightClass);

                    void leftPageDisplay.offsetWidth;

                    leftPageDisplay.classList.remove(inLeftClass);
                    rightPageDisplay.classList.remove(inRightClass);
                    leftPageDisplay.classList.remove(outLeftClass);
                    rightPageDisplay.classList.remove(outRightClass);

                    setTimeout(updateButtonStates, animationDuration);
                }, animationDuration);
            }

            function moveVisibleContentToStorage() {
                const leftContent = leftPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                if (leftContent) pageDataStorage.appendChild(leftContent);
                const rightContent = rightPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                if (rightContent) pageDataStorage.appendChild(rightContent);
            }

            function updateButtonStates() {
                prevButton.disabled = currentSpreadIndex <= 0;
                const lastPageNumber = totalPages - 1;
                const leftVisiblePageNum = (currentSpreadIndex - 1) * 2;
                const rightVisiblePageNum = leftVisiblePageNum + 1;
                nextButton.disabled = rightVisiblePageNum >= lastPageNumber;

                const leftPage = leftPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                const rightPage = rightPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                addImageButton.disabled = currentSpreadIndex === 0 || (!leftPage && !rightPage);
                addImageButton.title = addImageButton.disabled ? (currentSpreadIndex === 0 ? "Cannot add images to the cover" : "No page available to add image") : "Add Image from Device";
            }

            prevButton.addEventListener('click', prevPage);
            nextButton.addEventListener('click', nextPage);

            addImageButton.addEventListener('click', () => {
                if (!addImageButton.disabled) imageUploadInput.click();
            });

            imageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        let targetPage = rightPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                        if (!targetPage) targetPage = leftPageDisplay.querySelector('.page-content:not(.placeholder-page)');
                        if (targetPage) addImageElement(event.target.result, targetPage);
                        else alert("Cannot add image here. Please navigate to a valid page.");
                    };
                    reader.readAsDataURL(file);
                } else if (file) {
                    alert("Please select a valid image file (e.g., JPG, PNG, GIF).");
                }
                e.target.value = null;
            });

            document.addEventListener('keydown', (e) => {
                if (e.target.closest('[contenteditable="true"]') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    if ((e.key === 'Backspace' || e.key === 'Delete') && selectedElement && document.activeElement !== selectedElement && !selectedElement.contains(document.activeElement)) {
                        e.preventDefault();
                        selectedElement.remove();
                        selectedElement = null;
                    }
                    return;
                }

                if (e.key === 'ArrowLeft' && !prevButton.disabled) {
                    e.preventDefault();
                    prevPage();
                } else if (e.key === 'ArrowRight' && !nextButton.disabled) {
                    e.preventDefault();
                    nextPage();
                } else if ((e.key === 'Backspace' || e.key === 'Delete') && selectedElement) {
                    e.preventDefault();
                    selectedElement.remove();
                    selectedElement = null;
                }
            });

            updateView();
        });
    </script>
</body>
</html>
